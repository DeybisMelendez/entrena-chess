{% extends "base.html" %}
{% block title %}Inicio | Mi Entrenamiento{% endblock %}

{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script type="module" src="https://unpkg.com/chessboard-element/bundled/chessboard-element.bundled.js"></script>

<h3 style="text-align:center">
    Ciclo semanal: {{ cycle.completed_puzzles }} / {{ cycle.total_puzzles }}
</h3>

<p id="status" style="text-align:center"></p>
<p id="turn-indicator" style="text-align:center;font-weight:bold"></p>

<chess-board
    style="width: 400px; margin: auto"
    position="{{ puzzle.fen }}"
    orientation="{{ puzzle.orientation }}"
    draggable-pieces>
</chess-board>

<script>
const PUZZLE_ID = "{{ puzzle.puzzle_id }}";
const SUBMIT_URL = "{% url 'submit_puzzle' %}";
const CSRF_TOKEN = "{{ csrf_token }}";
let alreadySubmitted = false;
</script>

<script>

const board = document.querySelector("chess-board");
const highlightStyles = document.createElement("style");
document.head.appendChild(highlightStyles);

let styles = [];

function updateHighlights() {
    highlightStyles.textContent = styles.join("\n");
}

function clearHighlights() {
    styles = [];
    updateHighlights();
}

function highlightSquare(square, color) {
    return `
        chess-board::part(${square}) {
            box-shadow: inset 0 0 0 4px ${color};
        }
    `;
}

function highlightMove(move, color) {
    clearHighlights();
    styles.push(highlightSquare(move.from, color));
    styles.push(highlightSquare(move.to, color));
    updateHighlights();
}

/* ==========================
   Puzzle logic
   ========================== */

function updateTurnIndicator(game) {
    document.getElementById("turn-indicator").innerText =
        game.turn() === "w"
            ? "Juegan blancas"
            : "Juegan negras";
}

function submitResult(solved) {
    if (alreadySubmitted) return;
    alreadySubmitted = true;

    fetch(SUBMIT_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": CSRF_TOKEN
        },
        body: JSON.stringify({
            puzzle_id: PUZZLE_ID,
            solved: solved
        })
    })
    .then(res => res.json())
    .then(() => setTimeout(() => location.reload(), 1000));
}

function puzzleInit(fen) {
    const game = new Chess(fen);
    const solutionMoves = {{ puzzle.moves|safe }};
    let moveIndex = 0;
    let puzzleFailed = false;

    document.getElementById("status").innerText = "Resuelve el puzzle";
    updateTurnIndicator(game);

    // Jugada inicial del rival
    if (solutionMoves[moveIndex]) {
        setTimeout(() => {
            const m = solutionMoves[moveIndex];
            const move = game.move({
                from: m.slice(0, 2),
                to: m.slice(2, 4),
                promotion: "q"
            });

            board.setPosition(game.fen());
            highlightMove(move, "#2196f3"); // azul rival
            updateTurnIndicator(game);
            moveIndex++;
        }, 800);
    }

    board.addEventListener("drag-start", (e) => {
        const { piece } = e.detail;

        if (puzzleFailed || game.game_over()) e.preventDefault();

        if (
            (game.turn() === "w" && piece.startsWith("b")) ||
            (game.turn() === "b" && piece.startsWith("w"))
        ) {
            e.preventDefault();
        }
    });

    board.addEventListener("drop", (e) => {
        const { source, target, setAction } = e.detail;

        if (puzzleFailed) {
            setAction("snapback");
            return;
        }

        const expected = solutionMoves[moveIndex];
        const attempted = source + target;

        const move = game.move({
            from: source,
            to: target,
            promotion: "q"
        });

        if (!move) {
            setAction("snapback");
            return;
        }

        if (attempted !== expected) {
            puzzleFailed = true;
            game.undo();
            setAction("snapback");
            document.getElementById("status").innerText = "❌ Movimiento incorrecto";
            submitResult(false);
            return;
        }

        board.setPosition(game.fen());
        highlightMove(move, "#ffc107"); // amarillo jugador
        updateTurnIndicator(game);
        moveIndex++;

        if (!solutionMoves[moveIndex]) {
            document.getElementById("status").innerText = "✅ Puzzle resuelto";
            submitResult(true);
            return;
        }

        // Juega el rival
        setTimeout(() => {
            const m = solutionMoves[moveIndex];
            const reply = game.move({
                from: m.slice(0, 2),
                to: m.slice(2, 4),
                promotion: "q"
            });

            board.setPosition(game.fen());
            highlightMove(reply, "#2196f3");
            updateTurnIndicator(game);
            moveIndex++;
        }, 800);
    });

    board.addEventListener("snap-end", () => {
        board.setPosition(game.fen());
    });
}

puzzleInit("{{ puzzle.fen }}");
</script>

{% endblock %}
