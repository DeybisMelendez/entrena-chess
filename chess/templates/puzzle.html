{% extends "base.html" %}
{% block title %}Inicio | Mi Entrenamiento{% endblock %}

{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script type="module" src="https://unpkg.com/chessboard-element/bundled/chessboard-element.bundled.js"></script>

<article>
    <h3 style="text-align:center">
        Ciclo semanal: {{ cycle.completed_puzzles }} / {{ cycle.total_puzzles }}
    </h3>

    <p id="status" style="text-align:center"></p>
    <div class="grid">
        <div id="result" style="display:none">
            <div id="elo-result" style="text-align:center; margin-top:1rem;"></div>

            <div style="text-align:center; margin-top:1rem;">
                <button
                    id="next-puzzle-btn"
                    style="display:none;"
                >
                    Siguiente puzzle
                </button>
            </div>
        </div>

        <div>
            <p id="turn-indicator" style="text-align:center;font-weight:bold"></p>
            <chess-board
                style="width: 100%;max-width:400px; margin: auto"
                position="{{ puzzle.fen }}"
                orientation="{{ puzzle.orientation }}"
                draggable-pieces>
            </chess-board>
            <div style="text-align:center; margin-bottom:0.5rem;">
        <label>
            Auto promover al coronar:
            <select id="promotion-select">
                <option value="q">Dama</option>
                <option value="r">Torre</option>
                <option value="b">Alfil</option>
                <option value="n">Caballo</option>
            </select>
        </label>
        </div>
    </div>
</article>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const PuzzleApp = (() => {

        /* =======================
         * Constantes del backend
         * ======================= */
        const PUZZLE_ID = "{{ puzzle.puzzle_id }}";
        const SUBMIT_URL = "{% url 'submit_puzzle' %}";
        const CSRF_TOKEN = "{{ csrf_token }}";
        const SOLUTION = {{ puzzle.moves|safe }};
        const FEN = "{{ puzzle.fen|escapejs }}";

        /* =======================
         * Estado interno
         * ======================= */
        let game;
        let moveIndex = 0;
        let failed = false;
        let submitted = false;

        /* =======================
         * Cache del DOM
         * ======================= */
        const board = document.querySelector("chess-board");
        const statusEl = document.getElementById("status");
        const turnEl = document.getElementById("turn-indicator");
        const nextBtn = document.getElementById("next-puzzle-btn");
        const resultBox = document.getElementById("result");
        const eloBox = document.getElementById("elo-result");
        const promotionSelect = document.getElementById("promotion-select");

        /* =======================
         * Highlight de movimientos
         * ======================= */
        const styleEl = document.createElement("style");
        document.head.appendChild(styleEl);

        function highlight(from, to, color) {
            styleEl.textContent = `
                chess-board::part(${from}),
                chess-board::part(${to}) {
                    box-shadow: inset 0 0 0 4px ${color};
                }
            `;
        }

        /* =======================
         * Utilidades UI
         * ======================= */
        function updateTurn() {
            turnEl.textContent =
                game.turn() === "w"
                    ? "Juegan blancas"
                    : "Juegan negras";
        }

        function showResult(eloChanges) {
            resultBox.style.display = "block";
            nextBtn.style.display = "inline-block";

            let html = "<strong>Resultado del puzzle</strong><br><br>";
            eloChanges.forEach(c => {
                const delta = c.new - c.old;
                html += `
                    <div>
                        ${c.name}: ${c.old} → <strong>${c.new}</strong>
                        <span style="color:${delta >= 0 ? "green" : "red"}">
                            (${delta >= 0 ? "+" : ""}${delta})
                        </span>
                    </div>
                `;
            });

            eloBox.innerHTML = html;
        }

        /* =======================
         * Submit
         * ======================= */
        function submit(solved) {
            if (submitted) return;
            submitted = true;

            fetch(SUBMIT_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": CSRF_TOKEN
                },
                body: JSON.stringify({
                    puzzle_id: PUZZLE_ID,
                    solved: solved
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status !== "ok") return;
                showResult(data.elo_changes);
            });
        }

        /* =======================
         * Ejecutar jugada (motor)
         * ======================= */
        function playMove(moveStr, color) {
            const move = game.move({
                from: moveStr.slice(0, 2),
                to: moveStr.slice(2, 4),
                promotion: moveStr[4]
            });

            board.setPosition(game.fen());
            highlight(move.from, move.to, color);
            updateTurn();
            moveIndex++;
        }

        /* =======================
         * Inicialización
         * ======================= */
        function init() {

            game = new Chess(FEN);

            statusEl.textContent = "Resuelve el puzzle";
            updateTurn();

            // Botón siguiente puzzle
            nextBtn.addEventListener("click", () => {
                window.location.reload();
            });

            // Primera jugada del rival
            setTimeout(() => {
                playMove(SOLUTION[moveIndex], "#2196f3");
            }, 600);

            /* ========= Drag start ========= */
            board.addEventListener("drag-start", e => {
                if (failed || game.game_over()) {
                    e.preventDefault();
                    return;
                }

                const { piece } = e.detail;
                if (
                    (game.turn() === "w" && piece.startsWith("b")) ||
                    (game.turn() === "b" && piece.startsWith("w"))
                ) {
                    e.preventDefault();
                }
            });

            /* ========= Drop ========= */
            board.addEventListener("drop", e => {
                const { source, target, setAction } = e.detail;

                if (failed) {
                    setAction("snapback");
                    return;
                }

                const expected = SOLUTION[moveIndex];
                const promotion = promotionSelect.value || "q";

                // Intentar jugada en el motor (valida legalidad)
                const move = game.move({
                    from: source,
                    to: target,
                    promotion: promotion
                });

                // Jugada ilegal
                if (!move) {
                    setAction("snapback");
                    return;
                }

                // Normalizar jugada ejecutada
                const played =
                    move.from +
                    move.to +
                    (move.promotion ? move.promotion : "");

                // Comparar con solución
                if (played !== expected) {
                    failed = true;
                    game.undo();
                    setAction("snapback");
                    statusEl.textContent = "❌ Movimiento incorrecto";
                    submit(false);
                    return;
                }

                // Jugada correcta
                board.setPosition(game.fen());
                highlight(move.from, move.to, "#ffc107");
                updateTurn();
                moveIndex++;

                // Puzzle resuelto
                if (!SOLUTION[moveIndex]) {
                    statusEl.textContent = "✅ Puzzle resuelto";
                    submit(true);
                    return;
                }

                // Juega el rival
                setTimeout(() => {
                    playMove(SOLUTION[moveIndex], "#2196f3");
                }, 600);
            });
        }

        return { init };
    })();

    PuzzleApp.init();
});
</script>


{% endblock %}
