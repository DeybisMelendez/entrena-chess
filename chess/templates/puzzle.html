{% extends "base.html" %}
{% block title %}Inicio | Mi Entrenamiento{% endblock %}

{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script type="module" src="https://unpkg.com/chessboard-element/bundled/chessboard-element.bundled.js"></script>

<article>
    <h3 style="text-align:center">
        Ciclo semanal: {{ cycle.completed_puzzles }} / {{ cycle.total_puzzles }}
    </h3>

    <p id="status" style="text-align:center"></p>
    <div class="grid">
        <div id="result" style="display:none">
            <div id="elo-result" style="text-align:center; margin-top:1rem;"></div>

            <div style="text-align:center; margin-top:1rem;">
                <button
                    id="next-puzzle-btn"
                    style="display:none;"
                    onclick="goNextPuzzle()"
                >
                    Siguiente puzzle
                </button>
            </div>
        </div>

        <div>
            <p id="turn-indicator" style="text-align:center;font-weight:bold"></p>
            <chess-board
                style="width: 400px; margin: auto"
                position="{{ puzzle.fen }}"
                orientation="{{ puzzle.orientation }}"
                draggable-pieces>
            </chess-board>
        </div>
    </div>
</article>

<script>
const PUZZLE_ID = "{{ puzzle.puzzle_id }}";
const SUBMIT_URL = "{% url 'submit_puzzle' %}";
const CSRF_TOKEN = "{{ csrf_token }}";
let alreadySubmitted = false;
</script>

<script>

const board = document.querySelector("chess-board");
const highlightStyles = document.createElement("style");
document.head.appendChild(highlightStyles);

let styles = [];

function updateHighlights() {
    highlightStyles.textContent = styles.join("\n");
}

function clearHighlights() {
    styles = [];
    updateHighlights();
}

function highlightSquare(square, color) {
    return `
        chess-board::part(${square}) {
            box-shadow: inset 0 0 0 4px ${color};
        }
    `;
}

function highlightMove(move, color) {
    clearHighlights();
    styles.push(highlightSquare(move.from, color));
    styles.push(highlightSquare(move.to, color));
    updateHighlights();
}

function updateTurnIndicator(game) {
    document.getElementById("turn-indicator").innerText =
        game.turn() === "w"
            ? "Juegan blancas"
            : "Juegan negras";
}

function showNextButton() {
    document.getElementById("next-puzzle-btn").style.display = "inline-block";
}

function goNextPuzzle() {
    window.location.reload();
}

function renderEloResult(changes) {
    document.getElementById("result").style.display = "block";
    const container = document.getElementById("elo-result");
    if (!changes || !changes.length) return;

    let html = "<strong>Resultado del puzzle</strong><br><br>";

    changes.forEach(c => {
        const delta = c.new - c.old;
        const sign = delta >= 0 ? "+" : "";
        const color = delta >= 0 ? "green" : "red";

        html += `
            <div>
                ${c.name}:
                ${c.old} → <strong>${c.new}</strong>
                <span style="color:${color}">
                    (${sign}${delta})
                </span>
            </div>
        `;
    });

    container.innerHTML = html;
}


function submitResult(solved) {
    if (alreadySubmitted) return;
    alreadySubmitted = true;

    fetch(SUBMIT_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": CSRF_TOKEN
        },
        body: JSON.stringify({
            puzzle_id: PUZZLE_ID,
            solved: solved
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status !== "ok") return;

        renderEloResult(data.elo_changes);
        showNextButton();
    });
}

function puzzleInit(fen) {
    const game = new Chess(fen);
    const solutionMoves = {{ puzzle.moves|safe }};
    let moveIndex = 0;
    let puzzleFailed = false;

    document.getElementById("status").innerText = "Resuelve el puzzle";
    updateTurnIndicator(game);

    // Jugada inicial del rival
    if (solutionMoves[moveIndex]) {
        setTimeout(() => {
            const m = solutionMoves[moveIndex];
            const move = game.move({
                from: m.slice(0, 2),
                to: m.slice(2, 4),
                promotion: "q"
            });

            board.setPosition(game.fen());
            highlightMove(move, "#2196f3");
            updateTurnIndicator(game);
            moveIndex++;
        }, 800);
    }

    board.addEventListener("drag-start", (e) => {
        const { piece } = e.detail;

        if (puzzleFailed || game.game_over()) e.preventDefault();

        if (
            (game.turn() === "w" && piece.startsWith("b")) ||
            (game.turn() === "b" && piece.startsWith("w"))
        ) {
            e.preventDefault();
        }
    });

    board.addEventListener("drop", (e) => {
        const { source, target, setAction } = e.detail;

        if (puzzleFailed) {
            setAction("snapback");
            return;
        }

        const expected = solutionMoves[moveIndex];
        const attempted = source + target;

        const move = game.move({
            from: source,
            to: target,
            promotion: "q"
        });

        if (!move) {
            setAction("snapback");
            return;
        }

        if (attempted !== expected) {
            puzzleFailed = true;
            game.undo();
            setAction("snapback");
            document.getElementById("status").innerText = "❌ Movimiento incorrecto";
            submitResult(false);
            return;
        }

        board.setPosition(game.fen());
        highlightMove(move, "#ffc107");
        updateTurnIndicator(game);
        moveIndex++;

        if (!solutionMoves[moveIndex]) {
            document.getElementById("status").innerText = "✅ Puzzle resuelto";
            submitResult(true);
            return;
        }

        // Juega el rival
        setTimeout(() => {
            const m = solutionMoves[moveIndex];
            const reply = game.move({
                from: m.slice(0, 2),
                to: m.slice(2, 4),
                promotion: "q"
            });

            board.setPosition(game.fen());
            highlightMove(reply, "#2196f3");
            updateTurnIndicator(game);
            moveIndex++;
        }, 800);
    });

    board.addEventListener("snap-end", () => {
        board.setPosition(game.fen());
    });
}

puzzleInit("{{ puzzle.fen }}");
</script>

{% endblock %}
